#!/usr/bin/env python3

import click
import sys


def convert_dec(val):
    return int(val)


def convert_hex(val):
    return int(val, 16)


def convert_input(val, is_list):
    if is_list:
        val = val.split(',')
        func = convert_hex if 'x' in val[0] else convert_dec
        val = [func(c) for c in val]
    return val


def xor(data, key, is_list):
    key = convert_input(key, True)
    klen = len(key) - 1
    k = 0
    xored = list()
    for i in range(0, len(data)):
        xored.append(data[i] ^ key[k])
        if k == klen:
            k = 0
        else:
            k += 1
    return xored


@click.command()
@click.option('--data', '-d', type=str, required=False, help='Data argument, reads from stdin if not provided')
@click.option('--key', '-k', type=str, required=True, help='Key as comma separated list of hex or decimal values')
@click.option('--is-list', '-l', default=False, is_flag=True, help='Treat data as comma separated list of hex or decimal values')
@click.option('--output', '-o', type=str, required=False, help='Save output to file')
def run(data, key, is_list, output):
    if data is None:
        data = sys.stdin.buffer.read()
    data = convert_input(data, is_list)
    xored = xor(data, key, is_list)
    click.echo(click.style('Int: ' + ','.join([str(c) for c in xored]), fg='green', bold=True))
    click.echo(click.style('Hex: ' + ','.join([hex(c) for c in xored]), fg='yellow', bold=True))
    click.echo('Length: ' + str(len(data)))
    if output is not None:
        with open(output, 'wb') as fil:
            fil.write(bytes(xored))
        click.echo('Output saved to: ' + output)


if __name__ == '__main__':
    run()
