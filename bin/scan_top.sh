#!/bin/bash

if [[ -z $1 ]]; then
    echo "Usage: $0 10.0.0.0/24 300"
    exit 1
fi

export VAR_TARGET_CIDR=$1
export VAR_FILENAME=${VAR_TARGET_CIDR::${#VAR_TARGET_CIDR}-3}
export VAR_TARGET_HOSTS=$VAR_FILENAME-hosts.txt
nmap -sn -n -oA $VAR_FILENAME-ping-basic $VAR_TARGET_CIDR
sudo nmap -sn -n -PE -PP -PM -PS110,111,113,137,138,139,143,1433,1723,161,162,20,21,22,2001,2020,2222,23,2525,27017,3306,3389,389,4443,445,5020,5432,5061,587,5900,5901,636,6379,843,88,8000,8022,8080,8443,8888,993,995 -PU53,161,162,69,111,123,500 -oA $VAR_FILENAME-ping-extra $VAR_TARGET_CIDR
grep "Status: Up" $VAR_FILENAME-*.gnmap | cut -d" " -f2 | sort | uniq > $VAR_TARGET_HOSTS
nmap -Pn -n -v --top-ports $2 -iL $VAR_TARGET_HOSTS -oA $VAR_FILENAME-ports-top-$2
