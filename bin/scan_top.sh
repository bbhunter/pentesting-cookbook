#!/bin/bash

if [[ -z $1 ]]; then
    echo "Usage:"
    echo -e "- with host discovery, target as CIDR (network as output prefix):\n\t$0 10.0.0.0/24 300"
    echo -e "- skip host discovery, targets in a text file (filename as output prefix):\n\t$0 10.0.0.0-hosts 300"
    echo -e
    echo -e "NOTE: If executed as root the script will perform UDP and TCP SYN discovery (recommended anyway)."
    exit 1
fi

if [[ -f "$1" ]]; then
    echo "[*] Targets provided, skipping discovery..."
    FILENAME=$1
    TARGET_HOSTS=$1
else
    TARGET_CIDR=$1    
    FILENAME=${TARGET_CIDR::${#TARGET_CIDR}-3}
    TARGET_HOSTS=$FILENAME-hosts
    TCP_PORTS=110,111,113,1311,137,13782,138,139,143,1433,161,162,1723,20,21,22,23,2301,25,27017,3306,3389,389,443,4443,445,49152,49153,49154,49155,49156,49157,5020,5061,514,515,5432,587,5900,5901,636,6379,80,8000,8080,8082,81,82,843,8443,88,8888,993,995
    UDP_PORTS=111,123,161,53,69

    echo "[*] Basic ping sweep started..."
    nmap -sn -n -oA $FILENAME-ping-basic $TARGET_CIDR
    echo "[*] Extra TCP ACK sweep with selected ports started..."
    nmap -sn -n -PA$TCP_PORTS -oA $FILENAME-ping-extra $TARGET_CIDR
    if [ "$(id -u)" == "0" ]; then
        echo "[*] Extra TCP SYN sweep with selected ports started..."
        nmap -sn -n -PS$TCP_PORTS -oA $FILENAME-ping-extra $TARGET_CIDR
        echo "[*] Extra sweep with selected UDP ports started..."
        nmap -sn -n -PU$UDP_PORTS -oA $FILENAME-ping-udp $TARGET_CIDR
    fi
    grep "Status: Up" $FILENAME-ping*.gnmap | cut -d" " -f2 | sort | uniq > $TARGET_HOSTS
fi

TOP_PORTS=$2

hosts_list() {
    IFS=$'\n' read -r -d '' -a tmp_array < <( grep -E $1/$2 $FILENAME-ports-top-$3.gnmap | cut -d' ' -f2 | sort | uniq && printf '\0' )
    if (( ${#tmp_array[@]} )); then
        printf '%s\n' "${tmp_array[@]}" > $FILENAME-hosts-$4-$2
    fi
}

echo "[*] Scanning top $TOP_PORTS ports..."
nmap -Pn -n -v --open --top-ports $TOP_PORTS -iL $TARGET_HOSTS -oA $FILENAME-ports-top-$TOP_PORTS
hosts_list '21/open' tcp $TOP_PORTS ftp
hosts_list '22/open' tcp $TOP_PORTS ssh
hosts_list '23/open' tcp $TOP_PORTS telnet
hosts_list '25/open' tcp $TOP_PORTS smtp
hosts_list '53/open' tcp $TOP_PORTS dns
hosts_list '53/open' udp $TOP_PORTS dns
hosts_list '69/open' udp $TOP_PORTS tftp
hosts_list '80/open|81/open|82/open|443/open|8000/open|8008/open|8080/open|8081/open|8082/open|8443/open|8888/open|9000/open|9080/open|9443/open|9888/open|9990/open' tcp $TOP_PORTS http
hosts_list '111/open' tcp $TOP_PORTS rpc
hosts_list '111/open' udp $TOP_PORTS rpc
hosts_list '113/open' tcp $TOP_PORTS ident
hosts_list '135/open' tcp $TOP_PORTS msrpc
hosts_list '139/open|445/open' tcp $TOP_PORTS smb
hosts_list '161/open' tcp $TOP_PORTS snmp
hosts_list '161/open' udp $TOP_PORTS snmp
hosts_list '1433/open' tcp $TOP_PORTS mssql
hosts_list '3306/open' tcp $TOP_PORTS mysql
hosts_list '3389/open' tcp $TOP_PORTS rdp
hosts_list '5432/open' tcp $TOP_PORTS psql
