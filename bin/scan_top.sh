#!/bin/bash

if [[ -z $1 ]]; then
    echo "Usage:"
    echo -e "- with host discovery, target as CIDR (network as output prefix):\n\t$0 10.0.0.0/24 300"
    echo -e "- skip host discovery, targets in a text file (filename as output prefix):\n\t$0 10.0.0.0-hosts 300"
    echo -e
    echo -e "NOTE: If executed as root the script will perform UDP and TCP SYN discovery (recommended anyway)."
    exit 1
fi

if [[ -f "$1" ]]; then
    echo "[*] Targets provided, skipping discovery..."
    FILENAME=$1
    TARGET_HOSTS=$1
else
    TARGET_CIDR=$1
    FILENAME=${TARGET_CIDR::${#TARGET_CIDR}-3}
    TARGET_HOSTS=$FILENAME-hosts
    TCP_PORTS=21,22,23,139,445,80,443,8000,8080,8443,8888,8008,3389,1433,3306,5432,161,162,5900,6000,49152,49153,49154,49155,49156,49157,110,111,113,1311,137,138,143,1723,20,2301,2179,25,27017,389,4443,5061,514,515,587,5901,5984,5985,5986,636,6379,8082,81,82,88,993,995
    UDP_PORTS=111,69,161,53,123
    HOSTS_NUM=`prips $1 | wc -l`
    echo "[*] Basic ping sweep started..."
    nmap -sn -n --randomize-hosts -oA $FILENAME-ping-basic $TARGET_CIDR
    if cat $FILENAME-ping-basic.gnmap | grep "Nmap done" | grep -q "$HOSTS_NUM hosts up"; then
        echo "[*] All $HOSTS_NUM hosts up (in theory), ignoring basic ping results..."
        rm $FILENAME-ping-basic.gnmap
    fi
    echo "[*] Extra TCP ACK sweep with selected ports started..."
    nmap -sn -n --randomize-hosts -PA$TCP_PORTS -oA $FILENAME-ping-extra $TARGET_CIDR
    if cat $FILENAME-ping-extra.gnmap | grep "Nmap done" | grep -q "$HOSTS_NUM hosts up"; then
        echo "[*] All $HOSTS_NUM hosts up (in theory), ignoring extra TCP ACK ping results..."
        rm $FILENAME-ping-extra.gnmap
    fi
    if [ "$(id -u)" == "0" ]; then
        echo "[*] Extra TCP SYN sweep with selected ports started..."
        nmap -sn -n --randomize-hosts -PS$TCP_PORTS -oA $FILENAME-ping-extra $TARGET_CIDR
        echo "[*] Extra sweep with selected UDP ports started..."
        nmap -sn -n --randomize-hosts -PU$UDP_PORTS -oA $FILENAME-ping-udp $TARGET_CIDR
    fi
    grep "Status: Up" $FILENAME-ping*.gnmap | cut -d" " -f2 | sort | uniq > $TARGET_HOSTS
fi

TOP_PORTS=$2


echo "[*] Scanning top $TOP_PORTS ports..."
nmap -Pn -n --randomize-hosts -v --open --top-ports $TOP_PORTS -iL $TARGET_HOSTS -oA $FILENAME-ports-top-$TOP_PORTS

echo "[*] Parsing results..."
parse_gnmap.sh $FILENAME-ports-top-$TOP_PORTS.gnmap $FILENAME-ports-top-$TOP_PORTS
