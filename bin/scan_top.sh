#!/bin/bash

if [[ -z $1 ]]; then
    echo "Usage: $0 10.0.0.0/24 300"
    exit 1
fi

export VAR_TARGET_CIDR=$1
export VAR_FILENAME=${VAR_TARGET_CIDR::${#VAR_TARGET_CIDR}-3}
export VAR_TARGET_HOSTS=$VAR_FILENAME-hosts.txt

hosts_list() {
    IFS=$'\n' read -r -d '' -a tmp_array < <( grep -E $1/$2 $VAR_FILENAME-ports-top-$3.gnmap | cut -d' ' -f2 | sort | uniq && printf '\0' )
    if (( ${#tmp_array[@]} )); then
        printf '%s\n' "${tmp_array[@]}" > $VAR_FILENAME-hosts-$4-$2.txt
    fi
}

nmap -sn -n -oA $VAR_FILENAME-ping-basic $VAR_TARGET_CIDR
sudo nmap -sn -n -PE -PP -PM -PS110,111,113,137,138,139,143,1433,1723,161,162,20,21,22,2001,2020,2222,23,2525,27017,3306,3389,389,4443,445,5020,5432,5061,587,5900,5901,636,6379,843,88,8000,8022,8080,8443,8888,993,995 -PU53,161,69,111,123 -oA $VAR_FILENAME-ping-extra $VAR_TARGET_CIDR
grep "Status: Up" $VAR_FILENAME-*.gnmap | cut -d" " -f2 | sort | uniq > $VAR_TARGET_HOSTS
nmap -Pn -n -v --open --top-ports $2 -iL $VAR_TARGET_HOSTS -oA $VAR_FILENAME-ports-top-$2
hosts_list '21/open' tcp $2 ftp
hosts_list '22/open' tcp $2 ssh
hosts_list '23/open' tcp $2 telnet
hosts_list '25/open' tcp $2 smtp
hosts_list '53/open' tcp $2 dns
hosts_list '53/open' udp $2 dns
hosts_list '69/open' udp $2 tftp
hosts_list '80/open|81/open|82/open|443/open|8000/open|8008/open|8080/open|8081/open|8082/open|8443/open|8888/open|9000/open|9080/open|9888/open|9990/open' tcp $2 http
hosts_list '111/open' tcp $2 rpc
hosts_list '111/open' udp $2 rpc
hosts_list '135/open' tcp $2 msrpc
hosts_list '139/open|445/open' tcp $2 smb
hosts_list '161/open' tcp $2 snmp
hosts_list '161/open' udp $2 snmp
hosts_list '1433/open' tcp $2 mssql
hosts_list '3306/open' tcp $2 mysql
hosts_list '3389/open' tcp $2 rdp
hosts_list '5432/open' tcp $2 psql
